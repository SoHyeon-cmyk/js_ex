<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>강아지똥피하기</title>
  <style>
    #space {
      margin: 0 auto;
      display: block;
      background-image: url("images/space.png");
    }
  </style>
</head>

<body>
  <canvas id="space" width="550" height="500"></canvas>


  <script>

    let canvas = null; //캔버스 요소를 참조하는 변수
    let ctx = null; //캔버스의 2d그리기 컨텍스트를 나타내는 변수
    let canvasW = 0; let canvasH = 0 //캔버스의 넓이, 높이를 저장할 변수
    let intervalID = null; //게임루프 제어 변수
    let direction = null; //이동 방향을 나타내는 변수
    let score = 0//점수 저장 변수
    let gameOption = true; //중복 실행 제어

    //캔버스 초기화
    addEventListener('load', () => {
      canvas = document.getElementById('space')
      ctx = canvas.getContext('2d')
      canvasW = canvas.width;
      canvasH = canvas.height;
      help();
      //키보드를 누르면 키컨트롤 함수가 호출됨
      document.addEventListener("keydown", keyControl)
    })


    function help() {
      //게임의 도움말
      ctx.font = "20px 궁서체"
      ctx.fillStyle = "steelblue"
      ctx.textAlign = "center"
      ctx.fillText("게임 설명", 270, 130)
      ctx.fillText("게임 시작: space bar", 270, 170)
      ctx.fillText("움직이기 방향키: 왼쪽(<-), 오른쪽(->)", 270, 210)
    }

    //키보드 입력에 따라 게임의 동작을 제어하는 함수(32 = 스페이스바, 37 = 왼쪽방향키, 39 = 오른쪽방향키)
    function keyControl(event) {
      let selection = {
        32: 'startGame',
        37: 'left',
        39: 'right'
      }

      if (selection[event.keyCode] == 'startGame') {
        if(gameOption){
          gameOption = false;
          playGame();

        }
      } else { //화살표 버튼을 클릭한 경우 direction변수에 selection 객체값을 넣어줌
        direction = selection[event.keyCode]

      }
      console.log(selection[event.keyCode])
    }

    const Dog = {
      x: 100,
      y: 400,
      dogW: 80,
      dogH: 80,
      moveSpace: 20,//이동거리
      dogImage: 'images/dogRight.png',


      draw: function () { //강아지를 그려주는 메서드
        this.dog = new Image(); //이미지 객체 생성, dog속성에 할당
        this.dog.src = this.dogImage;
        ctx.drawImage(this.dog, this.x, this.y, this.dogW, this.dogH)
      },
      move: function () {//강아지를 왼오른쪽으로 이동시키는 메서드
        if (direction == 'right') {
          this.x += this.moveSpace; //x축 위치값을 moveSpace값 만큼 증가
        }
        if (this.x > canvasW - this.dogW) {
          this.x = canvasW = this.Dog
        }

        if (direction == 'left') {
          this.x -= this.moveSpace; //x축 위치값을 moveSpace값 만큼 증가
        }
        if (this.x < 0) {
          this.x = 0
        }
        direction = ""; //한번만 이동함
        this.dogImage = 'images/dogLeft.png';
      }
    }

    //드랍 요소객체를 생성할 생성자 함수
    const Dong = function(){
      this.yspeed =1;
      this.dongW = 40;
      this.dongH = 40;

      //위치값 랜덤
    this.x = Math.floor(Math.random() * (canvasW-this.dongW));
    this.y = Math.floor(Math.random() * (canvasH/3));

    this.draw = function(){
      const dong = new Image();
      dong.src = 'images/dong.png'
      ctx.drawImage(dong, this.x, this.y, this.dongW, this.dongH)

    }
    this.move = function(){
      this.y += this.yspeed
    }

    //오브젝트 충돌여부
    this.checkCollision =function(dog){
      let centerX = this.x + this.dongW/2;
      let centerY = this.y + this.dongH/2;
      let collideRange = 10;

      //가운데를 기준으로 강아지의 중심에 collidRange범위 안에 들어오면 gameover함수 실행
      if(
        centerX >= dog.x - collideRange &&
        centerX <= dog.x +dog.dogW + collideRange &&
        centerY >= dog.y - collideRange &&
        centerY <= dog.y + dog.dogH + collideRange
      ){
        gameOver();
      }

    //바닥과 충돌시
    if(centerY >450){
      this.x = Math.floor(Math.random() * (canvasW-this.dongW));
      this.y = Math.floor(Math.random() * (canvasH/3));
      score++;
    }
    }

    }


    //게임을 시작ㅎ고 게임 루프를 설정하는 함수
    function playGame() {
      const dongNum = 10; //생성할 동 객체 수 정의
      const dong = new Array(); //동 객체를 저장할 배열
      
      //5개의 동 객체를 배열에 할당

      for(let i=0; i<dongNum; i++){
        dong[i] = new Dong()
      }


      //0.2초마다 호출되는 함수
      intervalID = setInterval(function () {
        //캔버스를 지우고 강아지를 그림
        ctx.clearRect(0, 0, canvasW, canvasH)


        //순회하여 캔버스에 그림
        for(i=0; i<dongNum; i++){
          dong[i].move()
          dong[i].draw()
          dong[i].checkCollision(Dog)
          
        }

        

        Dog.move();
        Dog.draw();

        drawScore();
      }, 20)
    }

    function gmaeOver(){
      clearInterval(intervalID)
      ctx.font = '50px Ariel'
      ctx.fillText('Game over', canvasW/2, canvasH/2)
      gameOption = true;
    }

    function drawScore(){
      ctx.font = '20px Ariel';
      ctx.fillStyle = 'steelblue'
      ctx.textAlign = "left"
      ctx.fillText("Score" + score,10,30)
    }
  </script>
</body>

</html>